(()=>{"use strict";(()=>{const e=["gif","jpg","jpeg","png"];window.util={toggleDisabledOnFormNodes:(e,t)=>{Array.from(e).forEach((e=>{e.disabled=t}))},onSuccess:()=>{window.map.blockInterface(),window.success.addElement()},debounce:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},loadImg:(t,o)=>{const n=t.files[0],r=n.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(n)}}}})(),window.load=(e,t,o,n="GET",r)=>{const a=new XMLHttpRequest;a.responseType="json",a.addEventListener("load",(()=>{let e;switch(a.status){case 200:t(a.response);break;case 400:e="Неверный запрос";break;case 401:e="Пользователь не авторизован";break;case 404:e="Ничего не найдено :(";break;default:e="Cтатус ответа: : "+a.status+" "+a.statusText}e&&o(e)})),a.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),a.addEventListener("timeout",(()=>{o("Запрос не успел выполниться за "+a.timeout+"мс")})),a.timeout=1e3,a.open(n,e),a.send(r)},(()=>{const e={palace:{translation:"Дворец",price:1e4},flat:{translation:"Квартира",price:1e3},house:{translation:"Дом",price:5e3},bungalow:{translation:"Бунгало",price:0}},t=document.querySelector(".map__filters-container"),o=document.querySelector("#card").content.querySelector(".map__card"),n=()=>{r()},r=()=>{const e=window.map.mainMapElement.querySelector(".map__card");e&&e.remove()};window.card={BUILD_TYPES:e,addElementToDOM:a=>{r();const d=(t=>{let n=o.cloneNode(!0),r=n.querySelector(".popup__feature"),a=n.querySelector(".popup__features"),d=n.querySelector(".popup__photo"),i=n.querySelector(".popup__photos"),l=n.querySelector(".popup__avatar");return n.querySelector(".popup__title").textContent=t.offer.title,n.querySelector(".popup__text--address").textContent=t.offer.address,n.querySelector(".popup__text--price").textContent=t.offer.price+"₽/ночь",n.querySelector(".popup__type").textContent=e[t.offer.type].translation,n.querySelector(".popup__text--capacity").textContent=`${t.offer.rooms} комната(ы) для ${t.offer.guests} гостей`,n.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,n.querySelector(".popup__description").textContent=t.offer.description,l.src=t.author.avatar,a.textContent="",t.offer.features.forEach((e=>{let t=r.cloneNode();t.className="popup__feature",t.classList.add("popup__feature--"+e),a.appendChild(t)})),i.textContent="",t.offer.photos.forEach((e=>{let t=d.cloneNode();t.src=e,i.appendChild(t)})),t.author.avatar||l.classList.add("visually-hidden"),n})(a);t.insertAdjacentElement("beforebegin",d),d.querySelector(".popup__close").addEventListener("click",n)},deleteElements:r}})(),(()=>{const e="housing-type",t="housing-price",o={low:{min:0,max:9999},middle:{min:1e4,max:5e4},high:{min:5e4}},n="housing-rooms",r="housing-guests",a="features",d=e=>{window.advert.loaded=e.filter((e=>e.offer)),window.map.renderAdverts()};window.advert={loaded:[],generate:()=>{window.load("https://21.javascript.pages.academy/keksobooking/data",d,window.error.addDownloadMessage)},filter:d=>0===Object.keys(window.filter.filters).length?d:window.advert.loaded.filter((d=>{for(let i in window.filter.filters)if(window.filter.filters.hasOwnProperty(i))switch(i){case e:if(d.offer.type!==window.filter.filters[i])return!1;break;case t:let l=!1;if(d.offer.price>=o[window.filter.filters[i]].min&&(l=!0),o[window.filter.filters[i]].max&&d.offer.price>o[window.filter.filters[i]].max)return!1;if(!l)return!1;break;case n:if(d.offer.rooms!==Number(window.filter.filters[i]))return!1;break;case r:if(d.offer.guests!==Number(window.filter.filters[i]))return!1;break;case a:for(let e in window.filter.filters[i])if(window.filter.filters[i].hasOwnProperty(e)&&-1===d.offer.features.indexOf(window.filter.filters[i][e]))return!1}return!0}))}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={createElements:t=>{const o=document.createDocumentFragment();return t.forEach(((t,n)=>{o.appendChild(((t,o)=>{const n=e.cloneNode(!0),r=n.querySelector("img");return r.src=t.author.avatar,r.alt=t.offer.title,n.style.left=t.location.x-25+"px",n.style.top=t.location.y-70+"px",n.dataset.adverPosition=o,n})(t,n))})),o},deleteAll:()=>{window.map.pinElement.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}}})(),(()=>{const e=document.querySelectorAll("fieldset"),t=document.querySelectorAll(".map__filter"),o=document.querySelector("#address"),n=document.querySelector(".map__pins"),r=document.querySelector(".map__pin--main"),a=document.querySelector(".map");let d=!1,i=[];const l=()=>{i=window.advert.loaded.slice(),i=window.advert.filter(i),i=i.slice(0,5);const e=window.pin.createElements(i);n.appendChild(e),y()},s=(e,t)=>{r.style.top=e+"px",r.style.left=t+"px"},c=()=>{d=!0,f(),window.util.toggleDisabledOnFormNodes(e,!1),window.util.toggleDisabledOnFormNodes(t,!1),a.classList.remove("map--faded"),window.form.addFormElement.classList.remove("ad-form--disabled"),0===window.advert.loaded.length?window.advert.generate():l(),r.removeEventListener("keydown",w),r.removeEventListener("mousedown",u)},m=(e,t)=>{o.value=`${e}, ${t}`};let u=e=>{e.preventDefault(),0===e.button&&c()};const w=e=>{e.preventDefault(),13===e.keyCode&&c()},p=()=>{r.addEventListener("mousedown",u),r.addEventListener("keydown",w)},f=()=>{const e=r.offsetTop,t=r.offsetLeft;m(t+32,e+70)},v=e=>{const t=e.target.closest("button");if(t&&t.classList.contains("map__pin")&&!t.classList.contains("map__pin--main")){const e=i[t.dataset.adverPosition];window.card.addElementToDOM(e)}},y=()=>{document.addEventListener("click",v)};window.map={PIN_WIDTH:64,PIN_HEIGHT:70,pinElement:n,pinMainElement:r,mainMapElement:a,addMapPinHandlers:p,renderAdverts:l,blockInterface:()=>{s(375,570),(()=>{const e=r.offsetTop+35,t=r.offsetLeft+32;m(t,e)})(),window.util.toggleDisabledOnFormNodes(e,!0),window.util.toggleDisabledOnFormNodes(t,!0),d&&(window.pin.deleteAll(),window.card.deleteElements(),a.classList.add("map--faded"),window.form.addFormElement.classList.add("ad-form--disabled"),r.addEventListener("keydown",w),document.removeEventListener("click",v),window.form.clear(),window.filter.clear()),d=!1,p()},clearMapHandlers:()=>{document.addEventListener("keydown",(e=>{27===e.keyCode&&(window.card.deleteElements(),window.error.deleteElement(),window.success.deleteElement())})),document.addEventListener("mousedown",(()=>{window.error.deleteElement(),window.success.deleteElement()}))},setAddress:m,setMapPinElementPosition:s}})(),(()=>{const e="1000",t="flat",o="12:00",n="12:00",r="1",a="1",d="img/muffin-grey.svg",i=document.querySelector("#price"),l=document.querySelector("#timein"),s=document.querySelector("#timeout"),c=document.querySelector("#room_number"),m=document.querySelector("#capacity"),u=document.querySelector("#type"),w=document.querySelector(".ad-form"),p=w.querySelector(".ad-form-header__preview img"),f=w.querySelector(".ad-form__photo"),v=document.querySelector(".ad-form__reset"),y=document.querySelector(".ad-form-header__preview img"),_=e=>{const t=e.value,o=u.value;t<Number(e.placeholder)?e.setCustomValidity("Минимальная цена для этого типа жилья "+window.card.BUILD_TYPES[o].price):e.setCustomValidity(""),e.reportValidity()},g=(e,t,o)=>{t>0&&t>o&&100!==o?e.setCustomValidity(`Гостей (${t}) больше, чем комнат (${o})`):0===t&&100!==o?e.setCustomValidity("Требуется 100 комнат."):0!==t&&100===o?e.setCustomValidity("Аренда не для гостей"):e.setCustomValidity(""),e.reportValidity()};let E=e=>{e.target.matches("#title")?(e=>{const t=e.value.length;t<30?e.setCustomValidity("Ещё "+(30-t)+" симв."):t>100?e.setCustomValidity("Удалите лишние "+(t-100)+" симв."):e.setCustomValidity(""),e.reportValidity()})(e.target):e.target.matches("#price")&&_(e.target)};const h=e=>{var t,o;e.target.matches("#type")?(o=e.target,i.placeholder=window.card.BUILD_TYPES[o.value].price,i.min=window.card.BUILD_TYPES[o.value].price,_(i)):e.target.matches("#timein")||e.target.matches("#timeout")?(t=e.target.value,l.value=s.value=t):e.target.matches("#room_number")?(e=>{const t=Number(m.value),o=Number(e.value);g(e,t,o),g(m,t,o)})(e.target):e.target.matches("#capacity")?(e=>{const t=Number(c.value),o=Number(e.value);g(e,o,t),g(c,o,t)})(e.target):e.target.matches("#avatar")?window.util.loadImg(e.target,y):e.target.matches("#images")&&(e=>{const t=document.createElement("img");t.style.width="100%",t.style.height="100%",window.util.loadImg(e,t),f.textContent="",f.append(t)})(e.target)},S=e=>{e.preventDefault(),window.load("https://21.javascript.pages.academy/keksobooking",window.util.onSuccess,window.error.addUploadMessage,"POST",new FormData(w))},q=e=>{e.preventDefault(),window.map.blockInterface()};window.form={addFormElement:w,addFormHandlers:()=>{w.addEventListener("input",E),w.addEventListener("change",h),w.addEventListener("submit",S),v.addEventListener("click",q)},clear:()=>{w.reset(),i.placeholder=e,u.value=t,l.value=o,s.value=n,c.value=r,m.value=a,p.src=d,f.textContent=""}}})(),(()=>{const e=document.querySelector(".map__filters");let t=[];const o=window.util.debounce((o=>{o.preventDefault(),(()=>{t=[];let o=new FormData(e);o=o.entries();let n=o.next();for(;void 0!==n.value;)"any"!==n.value[1]?("features"===n.value[0]?(t[n.value[0]]||(t[n.value[0]]=[]),t[n.value[0]].push(n.value[1])):t[n.value[0]]=n.value[1],n=o.next()):n=o.next();window.filter.filters=t,window.pin.deleteAll(),window.card.deleteElements(),window.map.renderAdverts()})()}));window.filter={filters:t,clear:()=>{e.reset(),window.filter.filters=[]},setMapFilterFormHandlers:()=>{e.addEventListener("change",o)}}})(),(()=>{const e=window.map.pinElement.clientWidth,t=t=>{t.preventDefault();let o={x:t.pageX,y:t.pageY};const n=t=>{t.preventDefault();let n=o.x-t.pageX,r=o.y-t.pageY;o={x:t.pageX,y:t.pageY};let a=window.map.pinMainElement.offsetTop-r,d=window.map.pinMainElement.offsetLeft-n;a<130-window.map.PIN_HEIGHT?a=130-window.map.PIN_HEIGHT:a>630-window.map.PIN_HEIGHT&&(a=630-window.map.PIN_HEIGHT),d<0-window.map.PIN_WIDTH/2?d=-window.map.PIN_WIDTH/2:d>e-window.map.PIN_WIDTH/2&&(d=e-window.map.PIN_WIDTH/2),window.map.setAddress(d+window.map.PIN_WIDTH/2,a+window.map.PIN_HEIGHT),window.map.setMapPinElementPosition(a,d)},r=e=>{e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",r)};window.move={setMoveHandlers:()=>{window.map.pinMainElement.addEventListener("mousedown",t)}}})(),window.handlers={setHandlers:()=>{window.form.addFormHandlers(),window.map.addMapPinHandlers(),window.map.clearMapHandlers(),window.filter.setMapFilterFormHandlers(),window.move.setMoveHandlers()}},(()=>{const e=document.querySelector("#error").content.querySelector(".error"),t=document.querySelector("#load_error").content.querySelector(".load_error"),o=e.querySelector(".error__button");let n;const r=()=>{d()},a=()=>{window.map.pinElement.insertAdjacentElement("beforebegin",n),n.addEventListener("click",r)},d=()=>{n&&n.remove()};window.error={addDownloadMessage:e=>{d(),n=t.cloneNode(!0),n.textContent=e,a()},addUploadMessage:t=>{d(),n=e.cloneNode(!0),o.textContent=t,a(),window.map.blockInterface()},deleteElement:d}})(),(()=>{const e=document.querySelector("#success").content.querySelector(".success");let t;window.success={addElement:()=>{t||(t=e.cloneNode(!0)),window.map.pinElement.insertAdjacentElement("beforebegin",t)},deleteElement:()=>{t&&t.remove()}}})(),window.map.blockInterface(),window.handlers.setHandlers()})();