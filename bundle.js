(()=>{"use strict";(()=>{const e=["gif","jpg","jpeg","png"];window.util={toggleDisabledOnFormNodes:(e,t)=>{Array.from(e).forEach((e=>{e.disabled=t}))},onSuccess:()=>{window.map.blockInterface(),window.success.addSuccessElement()},debounce:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},loadImg:(t,o)=>{const r=t.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(r)}}}})(),window.load=(e,t,o,r="GET",n)=>{const a=new XMLHttpRequest;a.responseType="json",a.addEventListener("load",(()=>{let e;switch(a.status){case 200:t(a.response);break;case 400:e="Неверный запрос";break;case 401:e="Пользователь не авторизован";break;case 404:e="Ничего не найдено :(";break;default:e="Cтатус ответа: : "+a.status+" "+a.statusText}e&&o(e)})),a.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),a.addEventListener("timeout",(()=>{o("Запрос не успел выполниться за "+a.timeout+"мс")})),a.timeout=1e3,a.open(r,e),a.send(n)},(()=>{const e={palace:{translation:"Дворец",price:1e4},flat:{translation:"Квартира",price:1e3},house:{translation:"Дом",price:5e3},bungalow:{translation:"Бунгало",price:0}},t=document.querySelector(".map__filters-container"),o=document.querySelector("#card").content.querySelector(".map__card"),r=()=>{n()},n=()=>{const e=window.map.mainMapElement.querySelector(".map__card");e&&e.remove()};window.card={BUILD_TYPES:e,addCartElementToDOM:a=>{n();const d=(t=>{let r=o.cloneNode(!0),n=r.querySelector(".popup__feature"),a=r.querySelector(".popup__features"),d=r.querySelector(".popup__photo"),i=r.querySelector(".popup__photos"),s=r.querySelector(".popup__avatar");return r.querySelector(".popup__title").textContent=t.offer.title,r.querySelector(".popup__text--address").textContent=t.offer.address,r.querySelector(".popup__text--price").textContent=t.offer.price+"₽/ночь",r.querySelector(".popup__type").textContent=e[t.offer.type].translation,r.querySelector(".popup__text--capacity").textContent=`${t.offer.rooms} комната(ы) для ${t.offer.guests} гостей`,r.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,r.querySelector(".popup__description").textContent=t.offer.description,s.src=t.author.avatar,a.textContent="",t.offer.features.forEach((e=>{let t=n.cloneNode();t.className="popup__feature",t.classList.add("popup__feature--"+e),a.appendChild(t)})),i.textContent="",t.offer.photos.forEach((e=>{let t=d.cloneNode();t.src=e,i.appendChild(t)})),t.author.avatar||s.classList.add("visually-hidden"),r})(a);t.insertAdjacentElement("beforebegin",d),d.querySelector(".popup__close").addEventListener("click",r)},deleteCardElements:n}})(),(()=>{const e="housing-type",t="housing-price",o={low:{min:0,max:9999},middle:{min:1e4,max:5e4},high:{min:5e4}},r="housing-rooms",n="housing-guests",a="features",d=e=>{window.advert.loadedAdverts=e.filter((e=>e.offer)),window.map.addAdvertsToMap()};window.advert={loadedAdverts:[],generateAdverts:()=>{window.load("https://21.javascript.pages.academy/keksobooking/data",d,window.error.addDownloadError)},filterAdverts:d=>0===Object.keys(window.filter.filters).length?d:window.advert.loadedAdverts.filter((d=>{for(let i in window.filter.filters)if(window.filter.filters.hasOwnProperty(i))switch(i){case e:if(d.offer.type!==window.filter.filters[i])return!1;break;case t:let s=!1;if(d.offer.price>=o[window.filter.filters[i]].min&&(s=!0),o[window.filter.filters[i]].max&&d.offer.price>o[window.filter.filters[i]].max)return!1;if(!s)return!1;break;case r:if(d.offer.rooms!==Number(window.filter.filters[i]))return!1;break;case n:if(d.offer.guests!==Number(window.filter.filters[i]))return!1;break;case a:for(let e in window.filter.filters[i])if(window.filter.filters[i].hasOwnProperty(e)&&-1===d.offer.features.indexOf(window.filter.filters[i][e]))return!1}return!0}))}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=(t,o)=>{const r=e.cloneNode(!0),n=r.querySelector("img");return n.src=t.author.avatar,n.alt=t.offer.title,r.style.left=t.location.x-25+"px",r.style.top=t.location.y-70+"px",r.dataset.adverPosition=o,r};window.pin={createPin:t,createPins:e=>{const o=document.createDocumentFragment();return e.forEach(((e,r)=>{o.appendChild(t(e,r))})),o},deletePins:()=>{window.map.mapElement.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}}})(),(()=>{const e=document.querySelectorAll("fieldset"),t=document.querySelectorAll(".map__filter"),o=document.querySelector("#address"),r=document.querySelector(".map__pins"),n=document.querySelector(".map__pin--main"),a=document.querySelector(".map");let d=!1,i=[];const s=()=>{i=window.advert.loadedAdverts.slice(),i=window.advert.filterAdverts(i),i=i.slice(0,5);const e=window.pin.createPins(i);r.appendChild(e),_()},l=(e,t)=>{n.style.top=e+"px",n.style.left=t+"px"},c=()=>{d=!0,f(),window.util.toggleDisabledOnFormNodes(e,!1),window.util.toggleDisabledOnFormNodes(t,!1),a.classList.remove("map--faded"),window.form.addFormElement.classList.remove("ad-form--disabled"),0===window.advert.loadedAdverts.length?window.advert.generateAdverts():s(),n.removeEventListener("keydown",w),n.removeEventListener("mousedown",u)},m=(e,t)=>{o.value=`${e}, ${t}`};let u=e=>{e.preventDefault(),0===e.button&&c()};const w=e=>{e.preventDefault(),13===e.keyCode&&c()},p=()=>{n.addEventListener("mousedown",u),n.addEventListener("keydown",w)},f=()=>{const e=n.offsetTop,t=n.offsetLeft;m(t+32,e+70)},v=e=>{const t=e.target.closest("button");if(t&&t.classList.contains("map__pin")&&!t.classList.contains("map__pin--main")){const e=i[t.dataset.adverPosition];window.card.addCartElementToDOM(e)}},_=()=>{document.addEventListener("click",v)};window.map={MAP_PIN_WIDTH:64,MAP_PIN_HEIGHT:70,mapElement:r,mapPinElement:n,mainMapElement:a,addMapPinHandlers:p,addAdvertsToMap:s,blockInterface:()=>{l(375,570),(()=>{const e=n.offsetTop+35,t=n.offsetLeft+32;m(t,e)})(),window.util.toggleDisabledOnFormNodes(e,!0),window.util.toggleDisabledOnFormNodes(t,!0),d&&(window.pin.deletePins(),window.card.deleteCardElements(),a.classList.add("map--faded"),window.form.addFormElement.classList.add("ad-form--disabled"),n.addEventListener("keydown",w),document.removeEventListener("click",v),window.form.clearForm(),window.filter.clearFilter()),d=!1,p()},clearMapHandlers:()=>{document.addEventListener("keydown",(e=>{27===e.keyCode&&(window.card.deleteCardElements(),window.error.deleteErrorElement(),window.success.deleteSuccessElement())})),document.addEventListener("mousedown",(()=>{window.error.deleteErrorElement(),window.success.deleteSuccessElement()}))},setAddress:m,setMapPinElementPosition:l}})(),(()=>{const e="1000",t="flat",o="12:00",r="12:00",n="1",a="1",d="img/muffin-grey.svg",i=document.querySelector("#price"),s=document.querySelector("#timein"),l=document.querySelector("#timeout"),c=document.querySelector("#room_number"),m=document.querySelector("#capacity"),u=document.querySelector("#type"),w=document.querySelector(".ad-form"),p=w.querySelector(".ad-form-header__preview img"),f=w.querySelector(".ad-form__photo"),v=document.querySelector(".ad-form__reset"),_=document.querySelector(".ad-form-header__preview img"),y=e=>{const t=e.value,o=u.value;t<Number(e.placeholder)?e.setCustomValidity("Минимальная цена для этого типа жилья "+window.card.BUILD_TYPES[o].price):e.setCustomValidity(""),e.reportValidity()},E=(e,t,o)=>{t>0&&t>o&&100!==o?e.setCustomValidity(`Гостей (${t}) больше, чем комнат (${o})`):0===t&&100!==o?e.setCustomValidity("Требуется 100 комнат."):0!==t&&100===o?e.setCustomValidity("Аренда не для гостей"):e.setCustomValidity(""),e.reportValidity()};let g=e=>{e.target.matches("#title")?(e=>{const t=e.value.length;t<30?e.setCustomValidity("Ещё "+(30-t)+" симв."):t>100?e.setCustomValidity("Удалите лишние "+(t-100)+" симв."):e.setCustomValidity(""),e.reportValidity()})(e.target):e.target.matches("#price")&&y(e.target)};const h=e=>{var t,o;e.target.matches("#type")?(o=e.target,i.placeholder=window.card.BUILD_TYPES[o.value].price,i.min=window.card.BUILD_TYPES[o.value].price,y(i)):e.target.matches("#timein")||e.target.matches("#timeout")?(t=e.target.value,s.value=l.value=t):e.target.matches("#room_number")?(e=>{const t=Number(m.value),o=Number(e.value);E(e,t,o),E(m,t,o)})(e.target):e.target.matches("#capacity")?(e=>{const t=Number(c.value),o=Number(e.value);E(e,o,t),E(c,o,t)})(e.target):e.target.matches("#avatar")?window.util.loadImg(e.target,_):e.target.matches("#images")&&(e=>{const t=document.createElement("img");t.style.width="100%",t.style.height="100%",window.util.loadImg(e,t),f.textContent="",f.append(t)})(e.target)},S=e=>{e.preventDefault(),window.load("https://21.javascript.pages.academy/keksobooking",window.util.onSuccess,window.error.addUploadError,"POST",new FormData(w))},P=e=>{e.preventDefault(),window.map.blockInterface()};window.form={addFormElement:w,addFormHandlers:()=>{w.addEventListener("input",g),w.addEventListener("change",h),w.addEventListener("submit",S),v.addEventListener("click",P)},clearForm:()=>{w.reset(),i.placeholder=e,u.value=t,s.value=o,l.value=r,c.value=n,m.value=a,p.src=d,f.textContent=""}}})(),(()=>{const e=document.querySelector(".map__filters");let t=[];const o=window.util.debounce((o=>{o.preventDefault(),(()=>{t=[];let o=new FormData(e);o=o.entries();let r=o.next();for(;void 0!==r.value;)"any"!==r.value[1]?("features"===r.value[0]?(t[r.value[0]]||(t[r.value[0]]=[]),t[r.value[0]].push(r.value[1])):t[r.value[0]]=r.value[1],r=o.next()):r=o.next();window.filter.filters=t,window.pin.deletePins(),window.card.deleteCardElements(),window.map.addAdvertsToMap()})()}));window.filter={filters:t,clearFilter:()=>{e.reset(),window.filter.filters=[]},setMapFilterFormHandlers:()=>{e.addEventListener("change",o)}}})(),(()=>{const e=window.map.mapElement.clientWidth,t=t=>{t.preventDefault();let o={x:t.pageX,y:t.pageY};const r=t=>{t.preventDefault();let r=o.x-t.pageX,n=o.y-t.pageY;o={x:t.pageX,y:t.pageY};let a=window.map.mapPinElement.offsetTop-n,d=window.map.mapPinElement.offsetLeft-r;a<130-window.map.MAP_PIN_HEIGHT?a=130-window.map.MAP_PIN_HEIGHT:a>630-window.map.MAP_PIN_HEIGHT&&(a=630-window.map.MAP_PIN_HEIGHT),d<0-window.map.MAP_PIN_WIDTH/2?d=-window.map.MAP_PIN_WIDTH/2:d>e-window.map.MAP_PIN_WIDTH/2&&(d=e-window.map.MAP_PIN_WIDTH/2),window.map.setAddress(d+window.map.MAP_PIN_WIDTH/2,a+window.map.MAP_PIN_HEIGHT),window.map.setMapPinElementPosition(a,d)},n=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",n)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",n)};window.move={setMoveHandlers:()=>{window.map.mapPinElement.addEventListener("mousedown",t)}}})(),window.handlers={setHandlers:()=>{window.form.addFormHandlers(),window.map.addMapPinHandlers(),window.map.clearMapHandlers(),window.filter.setMapFilterFormHandlers(),window.move.setMoveHandlers()}},(()=>{const e=document.querySelector("#error").content.querySelector(".error"),t=document.querySelector("#load_error").content.querySelector(".load_error"),o=e.querySelector(".error__button");let r;const n=()=>{d()},a=()=>{window.map.mapElement.insertAdjacentElement("beforebegin",r),r.addEventListener("click",n)},d=()=>{r&&r.remove()};window.error={addDownloadError:e=>{d(),r=t.cloneNode(!0),r.textContent=e,a()},addUploadError:t=>{d(),r=e.cloneNode(!0),o.textContent=t,a(),window.map.blockInterface()},deleteErrorElement:d}})(),(()=>{const e=document.querySelector("#success").content.querySelector(".success");let t;window.success={addSuccessElement:()=>{t||(t=e.cloneNode(!0)),window.map.mapElement.insertAdjacentElement("beforebegin",t)},deleteSuccessElement:()=>{t&&t.remove()}}})(),window.map.blockInterface(),window.handlers.setHandlers()})();